# 消息收发功能测试指南

## 测试目标

实现完整的消息收发功能，包括：
1. 打开两个浏览器窗口（模拟两个用户）
2. 用户A发送消息 → 用户B立即收到
3. 刷新页面后历史消息能重新加载
4. 消息状态正确显示（发送中→已发送→已送达）

## 测试流程

### 步骤1：启动服务

确保以下服务正在运行：
- 前端服务：http://localhost:3000
- 后端API服务：http://localhost:3001
- WebSocket服务：ws://localhost:3002

### 步骤2：用户A操作

1. 打开浏览器窗口1，访问 http://localhost:3000
2. 点击"登录"按钮
3. 使用任意邮箱和密码登录（系统会自动创建用户）
4. 登录成功后，点击"进入聊天室"
5. 在聊天界面输入："Hello, 这是测试消息"
6. 点击"发送"按钮

### 步骤3：用户B操作

1. 打开浏览器窗口2（无痕/隐私模式），访问 http://localhost:3000
2. 点击"登录"按钮
3. 使用另一个邮箱和密码登录
4. 登录成功后，点击"进入聊天室"
5. 等待用户A的消息显示
6. 在输入框中输入："收到你的消息了"
7. 点击"发送"按钮

### 步骤4：用户A验证

1. 在浏览器窗口1中，应该立即看到用户B的回复消息
2. 刷新页面，验证历史消息是否正确加载

## 预期结果

### 用户A视角：
1. 发送消息后，消息显示在聊天记录中
2. 立即收到用户B的回复
3. 刷新页面后，所有消息仍然显示

### 用户B视角：
1. 立即收到用户A的消息
2. 发送回复后，回复消息显示在聊天记录中
3. 刷新页面后，所有消息仍然显示

## 技术实现说明

### 后端实现：
1. WebSocket服务器支持消息广播
2. 消息历史记录保存在内存中
3. 支持JWT令牌认证
4. 实现心跳检测机制

### 前端实现：
1. 使用Zustand进行消息状态管理
2. 实现WebSocket连接管理（自动重连、心跳检测）
3. 消息状态显示（发送中、已发送、已送达）
4. 历史消息加载和持久化

## 故障排除

### 常见问题：
1. **无法连接WebSocket**：检查3002端口是否被占用，重启后端服务
2. **消息无法发送**：检查网络连接，确保WebSocket已连接
3. **历史消息不显示**：检查浏览器localStorage权限

### 调试方法：
1. 打开浏览器开发者工具，查看控制台日志
2. 检查Network标签页中的WebSocket连接
3. 查看后端服务日志

## 测试脚本

可以使用 [message-test.js](file:///e:/我的微信/test/message-test.js) 进行自动化测试：
```bash
cd e:\我的微信\test
node message-test.js
```

该脚本会模拟两个用户的消息收发过程，验证功能是否正常。