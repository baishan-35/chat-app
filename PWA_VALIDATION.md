# PWA功能验证指南

## 概述
本文档详细说明了如何验证PWA清理后的功能，确保核心聊天功能正常工作。

## 验证清单

### 1. 环境配置验证
- [ ] 环境变量配置正确
- [ ] API调用使用相对路径
- [ ] WebSocket连接使用相对路径

### 2. 核心功能验证
- [ ] 用户认证流程完整
- [ ] 聊天功能正常工作
- [ ] 实时消息不受影响

### 3. PWA功能验证
- [ ] 应用可安装
- [ ] 离线功能正常
- [ ] 推送通知正常

## 详细验证步骤

### 1. 环境配置验证

#### 1.1 检查环境变量配置
```bash
# 检查前端环境变量文件
cat frontend/.env.local
```

预期输出：
```
# API基础URL - 使用相对路径以支持PWA
NEXT_PUBLIC_API_URL=

# WebSocket服务器URL - 使用相对路径以支持PWA
NEXT_PUBLIC_WS_URL=

# JWT密钥（开发环境使用默认值）
JWT_SECRET=default_secret_key_for_development
```

#### 1.2 检查Next.js配置
```bash
# 检查Next.js配置文件
cat frontend/next.config.js
```

确保API代理使用相对路径：
```javascript
async rewrites() {
  return [
    {
      source: '/api/:path*',
      destination: '/api/:path*'
    }
  ]
}
```

#### 1.3 检查WebSocket配置
```bash
# 检查WebSocket配置文件
cat frontend/lib/websocket.js
```

确保WebSocket使用相对路径：
```javascript
const WS_URL = process.env.NEXT_PUBLIC_WS_URL || (typeof window !== 'undefined' ? (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host : '');
```

### 2. 核心功能验证

#### 2.1 用户认证验证
1. 启动应用：
   ```bash
   cd frontend
   npm run dev
   ```

2. 访问登录页面：
   - 打开浏览器访问 http://localhost:3000/login
   - 输入测试用户凭据
   - 验证是否能成功登录

3. 检查认证请求：
   - 打开浏览器开发者工具
   - 查看网络请求
   - 确认登录请求发送到 `/api/auth/login`

#### 2.2 聊天功能验证
1. 登录后进入聊天页面：
   - 访问 http://localhost:3000/dashboard/chat
   - 验证WebSocket连接状态

2. 检查WebSocket连接：
   - 打开浏览器开发者工具
   - 查看控制台输出
   - 确认显示 "WebSocket连接已建立"

3. 发送测试消息：
   - 在聊天输入框输入测试消息
   - 点击发送
   - 验证消息是否成功发送和接收

#### 2.3 实时消息验证
1. 多用户测试：
   - 打开两个浏览器窗口
   - 使用不同用户登录
   - 在一个窗口发送消息
   - 验证另一个窗口是否实时收到消息

2. 连接稳定性测试：
   - 保持聊天页面打开10分钟
   - 验证WebSocket连接是否保持稳定
   - 检查是否有心跳检测日志

### 3. PWA功能验证

#### 3.1 应用安装验证
1. 在支持PWA的浏览器中打开应用：
   - Chrome/Edge/Firefox等现代浏览器
   - 华为浏览器（针对华为兼容性）

2. 检查安装提示：
   - 查看地址栏是否有安装图标
   - 或查看浏览器菜单中的安装选项

3. 安装应用：
   - 点击安装按钮
   - 验证应用是否成功安装到桌面

#### 3.2 离线功能验证
1. 缓存验证：
   - 首次访问应用并登录
   - 打开开发者工具查看缓存
   - 确认关键资源已被缓存

2. 离线测试：
   - 断开网络连接
   - 刷新页面
   - 验证是否能访问已缓存的页面

3. 离线消息处理：
   - 断开网络时尝试发送消息
   - 验证是否有适当的错误提示

#### 3.3 推送通知验证
1. 通知权限：
   - 检查浏览器通知权限设置
   - 确认应用有发送通知的权限

2. 推送测试：
   - 从另一个设备发送消息
   - 验证是否收到推送通知

3. 通知点击：
   - 点击推送通知
   - 验证是否能正确跳转到应用

## 华为手机特定验证

### 1. 浏览器兼容性
- [ ] 在华为浏览器中可以正常访问
- [ ] WebSocket连接在华为浏览器中正常工作
- [ ] PWA安装提示在华为浏览器中显示

### 2. 后台运行
- [ ] 应用在后台运行时WebSocket连接保持稳定
- [ ] 系统不会频繁杀死应用进程
- [ ] 电池优化设置正确

### 3. 通知适配
- [ ] 推送通知在华为手机上正常显示
- [ ] 通知图标正确显示
- [ ] 通知声音正常播放

## 常见问题及解决方案

### 1. WebSocket连接失败
**问题**: WebSocket无法建立连接
**解决方案**:
- 检查WebSocket URL配置是否正确
- 确认后端WebSocket服务正在运行
- 验证网络连接是否正常

### 2. API调用失败
**问题**: API请求返回404或网络错误
**解决方案**:
- 检查API代理配置
- 确认后端服务正在运行
- 验证环境变量配置

### 3. PWA安装失败
**问题**: 应用无法安装或安装后无法运行
**解决方案**:
- 检查manifest.json配置
- 验证Service Worker是否正常注册
- 确认所有必需的图标文件存在

## 测试工具

### 1. 浏览器开发者工具
- 网络面板：检查API请求和WebSocket连接
- 应用面板：检查Service Worker和缓存
- 控制台：查看日志输出

### 2. Lighthouse测试
使用Chrome DevTools的Lighthouse工具测试PWA功能：
```bash
# 在Chrome中打开开发者工具
# 选择Lighthouse标签
# 运行PWA测试
```

### 3. 华为测试工具
- 华为DevEco Studio
- 华为应用市场测试服务

## 验证结果记录

### 环境配置验证结果
- [ ] 环境变量配置正确
- [ ] API调用使用相对路径
- [ ] WebSocket连接使用相对路径

### 核心功能验证结果
- [ ] 用户认证流程完整
- [ ] 聊天功能正常工作
- [ ] 实时消息不受影响

### PWA功能验证结果
- [ ] 应用可安装
- [ ] 离线功能正常
- [ ] 推送通知正常

## 结论

通过以上验证步骤，可以确保PWA清理后的应用功能正常，核心聊天功能不受影响，并且在移动端（特别是华为手机）上有良好的兼容性。